<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>gt-pyg Audit — Model Impact Analysis</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 2rem auto; max-width: 1200px; color: #1a1a1a; background: #fafafa; }
  h1 { font-size: 1.4rem; margin-bottom: 0.3rem; }
  p.subtitle { color: #666; margin-top: 0; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  th { background: #2d3748; color: #fff; text-align: left; padding: 10px 12px; font-weight: 600; }
  td { padding: 8px 12px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
  tr:hover { background: #f7fafc; }
  .yes { color: #c53030; font-weight: 600; }
  .no { color: #718096; }
  .new td:first-child { border-left: 3px solid #3182ce; }
  code { background: #edf2f7; padding: 1px 5px; border-radius: 3px; font-size: 0.82rem; }
  .summary { margin-top: 1.5rem; padding: 1rem; background: #fff; border-left: 4px solid #c53030; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.9rem; }
</style>
</head>
<body>
<h1>gt-pyg Code Audit — Model Impact Analysis</h1>
<p class="subtitle">Reassessed 2026-02-07 — new findings marked with blue left border</p>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Finding</th>
  <th>Affects Model?</th>
  <th>Why</th>
</tr>
</thead>
<tbody>
<tr>
  <td>1</td>
  <td>Negative hydrogen count in charge neutralization</td>
  <td class="no">No</td>
  <td>Only triggered when <code>keep_charges=False</code>, which is never passed by <code>get_tensor_data</code> (defaults to <code>True</code>). Dead code path in current usage.</td>
</tr>
<tr>
  <td>2</td>
  <td>Single-atom molecules crash (<code>edge_attr</code> shape <code>(0,)</code> instead of <code>(0,D)</code>)</td>
  <td class="no">No</td>
  <td>Crashes before any model runs — <code>np.asarray([])</code> yields shape <code>(0,)</code> not <code>(0,D)</code>, which fails at the first layer. Runtime error, not silent corruption.</td>
</tr>
<tr>
  <td>3</td>
  <td><code>_eij</code> buffer breaks gradient checkpointing &amp; DataParallel</td>
  <td class="no">No</td>
  <td><code>self._eij</code> is a plain Python attribute set in <code>message()</code> and read in <code>forward()</code>. Would be overwritten or lost under <code>torch.utils.checkpoint</code> re-computation or <code>DataParallel</code> replication. Codebase uses neither today — latent bug, not active.</td>
</tr>
<tr>
  <td>4</td>
  <td><code>None</code> labels crash before <code>dtype==object</code> fallback</td>
  <td class="no">No</td>
  <td>In <code>_to_float_sequence</code>, <code>np.array(y_val, dtype=np.float32)</code> raises a <code>TypeError</code> when <code>y_val</code> contains <code>None</code>, so the <code>arr.dtype == object</code> guard on the next line is never reached. Crashes, doesn't silently produce wrong values.</td>
</tr>
<tr>
  <td>5</td>
  <td><strong>Edge post-norm vs node pre-norm asymmetry in GTConv</strong></td>
  <td class="yes">Yes</td>
  <td>Each <code>GTConv</code> layer applies a post-norm (<code>norm2e</code>) on its edge output (<code>edge_out = self.norm2e(e2)</code>), but node output exits without a final norm. This normalizes the edge residual stream at every layer exit, systematically compressing edge feature variance and potentially degrading gradient flow for edge information across stacked layers.</td>
</tr>
<tr>
  <td>9</td>
  <td><code>weights_only=False</code> — arbitrary code execution via pickle</td>
  <td class="no">No</td>
  <td>Both <code>load_checkpoint</code> and <code>get_checkpoint_info</code> pass <code>weights_only=False</code> to <code>torch.load</code>. Allows arbitrary code execution from untrusted <code>.pt</code> files. Security concern only — doesn't change predictions.</td>
</tr>
<tr>
  <td>12</td>
  <td><strong><code>NEG_IONIZABLE_SMARTS</code> misses sulfonates, phosphates, tetrazoles</strong></td>
  <td class="yes">Yes</td>
  <td>Pattern <code>[CX3](=O)[O-,OH]</code> only matches carboxylic acids/carboxylates. Sulfonates (<code>S(=O)(=O)[O-]</code>), phosphates (<code>P(=O)([O-])</code>), and tetrazole NHs all get <code>neg_ionizable=0</code> when they should be <code>1</code>. Wrong pharmacophore labels for common drug functional groups.</td>
</tr>
<tr>
  <td>13</td>
  <td><strong><code>POS_IONIZABLE_SMARTS</code> flags amides as ionizable</strong></td>
  <td class="yes">Yes</td>
  <td>Pattern <code>[#7;+,H2,H3]</code> matches any nitrogen with 2+ hydrogens. Primary amide nitrogens (<code>C(=O)NH₂</code>) match the <code>H2</code> condition but are not ionizable (pK<sub>a</sub> ≈ −1). Systematic mislabeling across amide-containing molecules.</td>
</tr>
<tr>
  <td>15</td>
  <td><strong><code>HBD_SMARTS</code> misses thiol S-H donors</strong></td>
  <td class="yes">Yes</td>
  <td>Pattern <code>[#7,#8;!H0]</code> only matches N and O. Thiol S-H groups (e.g., cysteine) are genuine H-bond donors but are never flagged. Minor effect (S-H is a weak donor) but systematically wrong for thiol-containing molecules.</td>
</tr>
<tr>
  <td>16</td>
  <td><strong>Kirchhoff diagonal on small molecules (non-standard)</strong></td>
  <td class="yes">Yes</td>
  <td>The GNM-derived Kirchhoff pseudoinverse diagonal is a standard feature for protein residue-level graphs (hundreds of nodes) but non-standard for small molecules (5–50 atoms). On tiny graphs the "vibrational" interpretation breaks down and the feature may act as noise rather than signal.</td>
</tr>
<tr>
  <td>17</td>
  <td><strong><code>get_period</code> returns 1 for dummy atoms</strong></td>
  <td class="yes">Yes</td>
  <td><code>atomic_num &lt;= 0</code> falls through to <code>return 1</code>, encoding dummy atoms identically to hydrogen in the period one-hot. If wildcard/dummy atoms appear, the model conflates them with H. (Rare in practice.)</td>
</tr>
<tr>
  <td>20</td>
  <td>Unreachable <code>"Unknown"</code> in category lists (+1 wasted dim)</td>
  <td class="no">No</td>
  <td><code>get_period</code> always returns 1–7 and <code>get_group</code> returns 0–18, so the <code>"Unknown"</code> sentinel in <code>PERIOD_CATEGORIES</code> and <code>GROUP_CATEGORIES</code> is never reached. Values are always 0; model learns a zero weight. Wasted capacity (trivial).</td>
</tr>
<tr>
  <td>21</td>
  <td>Duplicate version parsing in <code>_version.py</code> / <code>setup.py</code></td>
  <td class="no">No</td>
  <td>Both files contain independent git-based version derivation logic. Build/packaging only.</td>
</tr>
<tr>
  <td>22</td>
  <td><code>register_parameter</code> for optional submodules</td>
  <td class="no">No</td>
  <td>In <code>GTConv.__init__</code>, absent edge modules are registered via <code>self.register_parameter("WE_logits", None)</code> etc. Functionally equivalent to <code>self.x = None</code>. Code style.</td>
</tr>

<!-- ===== New findings from reassessment ===== -->

<tr class="new">
  <td>23</td>
  <td><strong>Edge embeddings bypass input normalization and dropout</strong></td>
  <td class="yes">Yes</td>
  <td>In <code>GraphTransformerNet.forward()</code>, node embeddings pass through <code>input_norm</code> and <code>input_dropout</code> before entering GTConv layers, but edge embeddings go directly from the linear projection (<code>edge_emb</code>) into the first GTConv layer with no normalization or dropout. Creates a scale mismatch between node and edge representations at the first transformer layer.</td>
</tr>
<tr class="new">
  <td>24</td>
  <td><strong><code>HBA_SMARTS</code> excludes P=O and S=O H-bond acceptors</strong></td>
  <td class="yes">Yes</td>
  <td>The H-bond acceptor pattern <code>[#7,#8;!$([#7,#8]=[!#6])]</code> excludes any oxygen double-bonded to a non-carbon atom. This filters out phosphate P=O, sulfoxide S=O, and sulfonamide S=O oxygens — all genuine H-bond acceptors common in drug-like molecules (e.g., celecoxib, ATP).</td>
</tr>
</tbody>
</table>

<div class="summary">
  <strong>Summary:</strong> Issues <strong>5, 12, 13, 15, 16, 17, 23, 24</strong> affect what the model actually learns (8 of 16 findings).
  Of those, <strong>#12</strong> and <strong>#13</strong> (wrong pharmacophore labels) are the most impactful — they systematically mislabel common functional groups across many drug-like molecules.
  Issues <strong>#5</strong> and <strong>#23</strong> (edge normalization asymmetries at the GTConv and model levels, respectively) compound to systematically disadvantage edge features throughout the network.
  New finding <strong>#24</strong> (<code>HBA_SMARTS</code> excluding P=O/S=O) adds a third pharmacophore mis-label alongside #12 and #15.
</div>

</body>
</html>
